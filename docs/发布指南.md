# 发布新版本指南

## 快速发布流程

当你完成代码修改并准备发布新版本时，按以下步骤操作：

### 1. 更新版本号

```bash
# 补丁版本更新 (1.0.0 → 1.0.1) - 用于 bug 修复
npm version patch

# 次版本更新 (1.0.0 → 1.1.0) - 用于新功能
npm version minor

# 主版本更新 (1.0.0 → 2.0.0) - 用于破坏性更改
npm version major
```

这个命令会自动：
- ✅ 更新 `package.json` 中的版本号
- ✅ 更新 `manifest.json` 中的版本号
- ✅ 更新 `versions.json` 版本兼容性映射
- ✅ 创建一个 git commit
- ✅ 创建一个 git tag

### 2. 推送到 GitHub

```powershell
# PowerShell 语法
git push; git push --tags

# 或者分两行执行
git push
git push --tags
```

### 3. 等待自动发布

GitHub Actions 会自动：
1. 检测到新标签
2. 安装依赖
3. 编译插件 (`npm run build`)
4. 创建 GitHub Release
5. 上传 `main.js`、`manifest.json`、`styles.css`

整个过程约需 1-2 分钟。

### 4. 验证发布

访问 GitHub 仓库的 Releases 页面，确认新版本已发布并包含所有文件。

## 完整示例

```powershell
# 1. 进入项目目录
cd e:\github_code\obsidian-vassago

# 2. 确保代码已提交
git add .
git commit -m "feat: 改进虚线间距"

# 3. 更新版本（自动创建 commit 和 tag）
npm version patch

# 4. 推送到 GitHub（PowerShell 语法）
git push
git push --tags

# 5. 等待 GitHub Actions 完成（约 1-2 分钟）
# 6. 访问 https://github.com/你的用户名/obsidian-vassago/releases 查看发布
```

## 本地测试构建

在发布前，建议先本地测试构建：

```bash
# 运行构建
npm run build

# 检查生成的文件
ls main.js manifest.json styles.css
```

## 版本号规范

遵循 [语义化版本](https://semver.org/lang/zh-CN/) 规范：

- **主版本号 (Major)**: 不兼容的 API 修改
- **次版本号 (Minor)**: 向下兼容的功能性新增
- **修订号 (Patch)**: 向下兼容的问题修正

## 手动发布（备用方案）

如果 GitHub Actions 失败，可以手动发布：

1. 本地构建：
   ```bash
   npm run build
   ```

2. 在 GitHub 上手动创建 Release

3. 上传 `release/` 目录中的文件：
   - `main.js`
   - `manifest.json`
   - `styles.css`

## 故障排查

### 工作流未触发

- 确保标签格式为 `X.Y.Z`（如 `1.0.1`），不要使用 `v` 前缀
- 检查 GitHub Actions 是否已启用
- 查看 GitHub Actions 标签页是否有错误

### 构建失败

- 先在本地运行 `npm run build` 确保能成功编译
- 检查 TypeScript 错误
- 查看 GitHub Actions 日志获取详细错误信息

### 文件上传失败

- 确认构建后 `main.js`、`manifest.json`、`styles.css` 存在
- 检查 GitHub Token 权限（通常自动配置）

## 相关文件

- `.github/workflows/release.yml` - 自动发布工作流配置
- `version-bump.mjs` - 版本更新脚本
- `package.json` - 主版本号来源
- `manifest.json` - Obsidian 插件清单
- `versions.json` - 版本兼容性映射

## 注意事项

- 每次发布前确保代码已充分测试
- 版本号一旦发布就不能修改，只能发布新版本
- 保持 CHANGELOG 更新（如果有的话）
- 重大更改应该在 Release Notes 中说明
